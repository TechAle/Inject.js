<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="htmlAnalysys.js"></script>
    <script src="inject.js"></script>
    <script src="injectClassFile.js"></script>
</head>
<body>
<script>

    let testNormale3 = new injectClass({
        file: "none",
        method: "none",
        function: "testNew",
        pre: () => {
            console.log("pre")
            return false
        },
        cancellable: true
    });

    let testNormale = new injectClass({
        file: "none",
        method: "none",
        function: "primo",
        pre: () => {
            console.log("pre")
        }
    });

    let testNormale2 = new injectClass({
        file: "none",
        method: "none",
        function: "secondo_multiplo=>variabile_funzione",
        pre: () => {
            console.log("pre")
            return false
        },
        cancellable: true
    });

    calculateLinks()

    // Here we get as input the html
    let html = "<html lang='it'><script> var token = 'si'; function primo(){var a = 0} " +
        "function secondo_multiplo(){" +
        "var variabile_funzione = function (a,b) {console.log('ciao')}" +
        "}function testNew(){var a = 0}<\/script><script>function nuovo_script_multiplo() {" +
        "function normale_dentro() {" +
        "var c = 0;" +
        "}" +
        "}<\/script></html>"

    // First we have to get every functions
    var output = analyzeHtml(html)


    function findFunction(fun, output, fullDebug) {
        var toChecks = fun.split("=>")
        // Get correct
        var toCheck = toChecks.shift();
        for(let scriptIdx = 0; scriptIdx < output.length; scriptIdx++) {
            for(let functionIdx = 0; functionIdx < output[scriptIdx].length; functionIdx++) {
                if (output[scriptIdx][functionIdx].name === toCheck) {
                    if (toChecks.length > 0)
                        return findFunction(toChecks.join("=>"), output[scriptIdx][functionIdx].insideFunctions, fun)
                    else return output[scriptIdx][functionIdx]
                }
            }
        }
        throw "No method found " + fullDebug
    }

    // Check if the file is correct (yes.)
    let thingsToInject = links[0].toInject;
    /// Start to inject
    // Get every functions, calculate the idx and put everything in a array
    let toInject = []
    for(let i = 0; i < thingsToInject.length; i++) {
        const functionToInject = findFunction(thingsToInject[i].function, output, thingsToInject[i].function)
        toInject.push({
            inject: thingsToInject[i],
            function: functionToInject,
            idx: calculateIdx(functionToInject)
        })
    }
    // Now, because of how it's done, i have to sort everything
    sortIdx(toInject)
    // We can finally inject
    let copyHtml = html;

</script>
</body>
</html>